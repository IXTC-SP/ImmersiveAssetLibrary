<%- include('../partials/header') %>

<!-- <link rel="stylesheet" href="./public/edit-page.css"> -->
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<script type="text/javascript" src="/datamuse.js"></script>

<section class="d-flex flex-column m-auto mt-5">


  <!-- <div class="container-fluid">
    <div class="row">
      <div class="col-6 d-flex align-items-end flex-column">
        <h5 class="asset-name">cyberpunk shiba inu</h5>
      </div>
    </div>
  </div> -->
  <div class="container-fluid">
    <h2 class="Title">Edit Properties</h2><br>
    <div class="row justify-content-center">
      <div class="col-6">
        <div class="row">
          <h5 class="asset-name">cyberpunk shiba inu</h5>
        </div>
        <div class="mb-3 ">
          <model-viewer class="model-viewer-dimensions border border-secondary rounded-4"id="model-viewer" alt="" src='../uploads/shiba/gltf/scene.gltf' ar ar-modes="webxr scene-viewer quick-look" seamless-poster shadow-intensity="1" camera-controls enable-pan></model-viewer>
        </div>
        <h5>Additional Files</h5>
        <div class="all-files">
          <% for(var i=0; i<content.imagefiles.length; i++) {%>
          <div class="current-file">
            <span><%=content.imagefiles[i]%></span>
            <button class="remove-file bg-transparent border-0" onclick="removeExistingFile(this,'<%-content.imagefiles[i]%>')"><i class="fa-regular fa-trash-can trash-btn"></i
              ></button>
          </div>
          <%}%>
        </div>
        <br>
        <div class="custom-file">
          <input type="file" class="custom-file-input" id="inputGroupFile01" accept="image/png, image/jpeg" onchange="addNewFile(this)">
          <label class="custom-file-label" for="inputGroupFile01" >Choose file</label>
        </div>
      </div>
      <div class="col-6 d-flex flew-wrap gap-2 flex-column">
      <div>
          <h5>Title</h5>
          <input class="title-info w-100" type="text" class="form-control" placeholder="" aria-label="Username" aria-describedby="basic-addon1">
        </div>
        <div>
          <h5>Description</h5>
          <textarea class="desc-info desc-info-dimension form-control" aria-label="With textarea"></textarea>
        </div>
      <div>
     
      <div class="d-flex justify-content-between">
        <h5>Technical Details</h5>
        <div class="form-check form-check-inline p-0">
          <input class="low-poly-info" name="optradio" class="form-check-input" type="checkbox" id="detail-lowpoly" value="lowpoly" />
          <label class="form-check-label" for="detail-lowpoly">Low-poly</label>
        </div>
        <div class="form-check form-check-inline p-0">
          <input class="rigged-info" name="optradio" class="form-check-input" type="checkbox" id="detail-rigged" checked value="rigged" />
          <label class="form-check-label" for="detail-rigged" checked>Rigged</label>
        </div>
        <div class="form-check form-check-inline p-0">
          <input class="animated-info" name="optradio" class="form-check-input" type="checkbox" id="detail-animated" checked value="animated" />
          <label class="form-check-label" for="detail-animated" checked>Animated</label>
        </div>
        <div class="form-check form-check-inline p-0">
          <input class="textured-info" name="optradio" class="form-check-input" type="checkbox" id="detail-texture" checked value="textures" />
          <label class="form-check-label" for="detail-texture" checked>Textured</label>
        </div>
      </div>
    </div>     

    <div>
      <h5>Tags</h5>
      <input type="text" id="tag_input_content" name="tag_input_content" value="" readonly>
      <div id="selected_tags_group" class="selected-tags"></div>
      <input type="text" class="form-control" type="text" id='tag_create' value="" placeholder="" aria-label="Username" aria-describedby="basic-addon1">
      <div class="d-flex flex-wrap gap-2 justify-content-sm-start" id="tag_suggest">
      </div>
      
    </div>
    <div class="container-fluid">
      <div class="row justify-content-between">
        <div class="col-4">
          <button type="button" class="btn btn-outline-info rounded-8">Delete</button>
        </div>
        <div class="col-4 d-flex  justify-content-end">
          <!-- <button type="button" class="mr-4 btn btn-lg btn-outline-primary text-white">Preview</button> -->
      
          <button onclick="createUploadContent()" type="button" class="publish-btn btn theme-color btn-rounded" >Publish</button>
        </div>
      </div>
</div>
  </section>
<script>
  var suggestedtagelements = [];
  var selectedtagelements = [];
  var files = [];
  var newfiles = [];
  var modelviewer = document.getElementById('model-viewer');
  async function createUploadContent() {
    const formData = new FormData();
    const request = new XMLHttpRequest();
    var nextURL = "/view-model";
    var postURL = "/save3dmodel";
    console.log("create upload content");

    var data = {
      files : [],
      modelfile: <%- JSON.stringify(content.modelfile)%>,
      title : document.querySelector(".title-info").value,
      description : document.querySelector(".desc-info").value,
      lowpoly : document.querySelector(".low-poly-info").checked,
      rigged : document.querySelector(".rigged-info").checked,
      animated : document.querySelector(".animated-info").checked,
      textured : document.querySelector(".textured-info").checked,
      tags : []
      }
      var tags = document.querySelectorAll("#selected_tag_element");
      for(i = 0; i<tags.length;i++){ data.tags.push(tags[i].innerText); }
      data.files=files;
      console.log(data);
      for(i=0; i< newfiles.length;i++)
      { formData.append('file', newfiles[i]); }
      formData.append('data', JSON.stringify(data));
      let thumbnailpath='<%- content.thumbnail %>' ;
      if(thumbnailpath=='')
      {
        var modelviewer=document.getElementById('model-viewer');
        var blob = await modelviewer.toBlob();
        var file = new File([blob], 'new_thumbnail.png');
        console.log(file);
        formData.append('newthumbnail', file);
      }


      // request.onreadystatechange = function() { // listen for state changes
      // if (request.readyState == 4 && request.status == 200) { // when completed we can move away
      // window.location = nextURL;
      // }
      // }
      request.open("POST", postURL, false);
      request.send(formData);
  }


  getEJScontent();

  function getEJScontent(){
  <% if (content) {  %>
  files = <%- JSON.stringify(content.imagefiles)%>;
  let modelpath = '<%- content.modelviewerpath %>';
  modelviewer.src = modelpath;
  console.log(getTextureFromFilesArray('diffuse'));
  <% } else { %>
  console.log("does not exist");
  <% } %>

  console.log(modelviewer);
  modelviewer.addEventListener('load', saveThumbnail);
  }

  function getTextureFromFilesArray(typename){
    var result ="";
    for(i=0;i<files.length;i++){
      if(files[i].split("_")[0] == typename){
        result = files[i];
      }
    }
    return result;
  }

  modelviewer.addEventListener("load", () => {
  const material = modelviewer.model.materials[0];
  const createAndApplyTexture = async (channel) => {
    // Applies the new texture to the specified channel.
    var diffusepath = getTextureFromFilesArray('diffuse');
    if(diffusepath != ""){
      var diffuse = await modelviewer.createTexture("../uploads/tmp/" + diffusepath);
      material.pbrMetallicRoughness['baseColorTexture'].setTexture(diffuse);
    }
    var emissivepath = getTextureFromFilesArray('emissive');
    if(emissivepath != ""){
      var emission = await modelviewer.createTexture("../uploads/tmp/" + emissivepath);
      material['emissiveTexture'].setTexture(emission);
    }
  }
    createAndApplyTexture('baseColorTexture');
  });

  function saveThumbnail(callback){
  console.log('running save thumbnail 2');
  //create thumbnail via canvas then save in formdata afterwards
  // var image = modelviewer.toDataURL("image/png", 0.5).replace("image/png", "image/octet-stream"); // here is the most important part because if you dont replace you will get a DOM 18 exception.
  modelviewer.toBlob((result)=>{
  console.log(result);
  callback(result)
  }, 'image/jpeg');
  }


  function removeExistingFile(el, filename){
  files = files.filter(i => i !== filename);
  console.log(files);
  var element = el;
  element.parentElement.remove();
  }

  function addNewFile(el){
  console.log(el.files[0].name);
  newfiles.push(el.files[0]);
  let p = document.querySelector('.all-files')
  console.log(p);
  let main = document.createElement('div');
  main.classList.add("new-file");
  p.appendChild(main);
  let btn = document.createElement('button');
  btn.innerHTML = '<i id ="trash-icon" class="trash-btn fa-regular fa-trash-can"></i>';
  btn.className="remove-file bg-transparent border-0"
  let tag = document.createElement("span");
  tag.innerHTML = el.files[0].name;
  main.appendChild(tag);
  main.appendChild(btn);
  btn.onclick = function(){
  removeNewFile(main,el.files[0]);
  }
  }

  function removeNewFile(el,file){
  newfiles = newfiles.filter(i => i !== file);
  var element = el;
  element.remove();
  }




  const node = document.getElementById("tag_create");
  node.addEventListener("keyup", function(event) {
  if (event.key === "Enter") {
  // Do work
  if (selectedtagelements.includes(node.value)) return;
  addTag(node.value);
  createTagSuggestion(node.value);
  node.value = "";

  }
  });

  function clearsuggestedtagelements() {
  if (suggestedtagelements.length === 0) return;
  suggestedtagelements.forEach(e => {
  e.remove();
  })
  }

  function createTagSuggestion(tagname) {
  clearsuggestedtagelements();
  suggestionsFromDatamuse(tagname).then(result => {
  result.forEach(a => {
  createSuggestElement(a.word);
  });
  });
  }

  function createSuggestElement(tagname) {
  let col = document.createElement('div');
  col.classList = 'suggested-tag border-secondary border rounded-2 px-1';
  document.getElementById('tag_suggest').appendChild(col);
  let tag = document.createElement("div");
  tag.innerHTML = tagname;
  let addBtn = document.createElement("button")
  addBtn.innerHTML= '<i class="fa-solid fa-plus"></i>';
  addBtn.classList="bg-transparent border-0 ms-2 p-0"
  col.append(tag,addBtn);
  //tag.classList.add('tag_element');
  addBtn.onclick = function() {
  if (selectedtagelements.includes(tagname)) return;
  addTag(tagname);
  createTagSuggestion(tagname);
  };
  //add to suggested tag element array
  suggestedtagelements.push(col);
  }

  function addTag(tagname) {
  //get div child from group
  var div = document.getElementById('selected_tags_group');
  //create div to inclde tag + cross btn
  var tagDiv= document.createElement('div');
  tagDiv.classList="tag border border-secondary rounded-2 px-1 text-white"
  //create x button
  var tagBtn = document.createElement('button');
  tagBtn.innerHTML="x"
  tagBtn.classList="bg-transparent border-0 ms-2 p-0 text-white"
  //create span element with id of selected_tag_element
  var tag = document.createElement('span');
  tagDiv.append(tag,tagBtn)
  tag.innerText = " " + tagname;
  tag.setAttribute("class", "selected_tag_element");
  tagBtn.onclick = function() {
  div.removeChild(tagDiv);
  selectedtagelements = selectedtagelements.filter(e => e !== tagname);
  };
  div.appendChild(tagDiv);
  let taginput = document.getElementById("tag_input_content");
  taginput.value = selectedtagelements.toString();
  selectedtagelements.push(tagname);
  }
  </script>


  <%- include('../partials/footer') %>
